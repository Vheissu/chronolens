<section class="grid gap-4 md:grid-cols-3">
  <mdui-card class="glass popover-safe p-5 md:col-span-2 space-y-4">
    <h2 class="text-xl font-semibold flex items-center gap-2">
      <mdui-icon name="tune"></mdui-icon>
      Generate
    </h2>

    <div class="grid gap-3 md:grid-cols-2">
      <div class="space-y-2">
        <div class="text-sm opacity-70">Upload photo</div>
        <label class="dropzone cursor-pointer">
          <mdui-icon name="upload" class="opacity-80"></mdui-icon>
          <div class="text-sm">Drag & drop or click to upload</div>
          <div class="text-xs opacity-60">JPEG, PNG, or WebP up to 5 MB</div>
          <input class="sr-only" type="file" accept="image/jpeg,image/png,image/webp" change.trigger="onPickSource($event)" />
        </label>
        <template if.bind="sourcePreview">
          <img class="rounded-lg max-h-56 ring-1 ring-black/5" src.bind="sourcePreview" alt="Source preview"/>
        </template>
      </div>

      <div class="space-y-2">
        <div class="text-sm opacity-70">Era, intensity, and style</div>
        <div class="flex gap-2 items-center">
          <mdui-select label="Era" value.two-way="era">
            <mdui-menu-item value="1890">1890</mdui-menu-item>
            <mdui-menu-item value="1920">1920</mdui-menu-item>
            <mdui-menu-item value="1940">1940</mdui-menu-item>
            <mdui-menu-item value="1970">1970</mdui-menu-item>
            <mdui-menu-item value="1980">1980</mdui-menu-item>
            <mdui-menu-item value="1990">1990</mdui-menu-item>
            <mdui-menu-item value="2000">2000</mdui-menu-item>
            <mdui-menu-item value="2010">2010</mdui-menu-item>
            <mdui-menu-item value="2090">2090</mdui-menu-item>
          </mdui-select>
          <mdui-select label="Intensity" value.two-way="variant">
            <mdui-menu-item value="mild">Mild</mdui-menu-item>
            <mdui-menu-item value="balanced">Balanced</mdui-menu-item>
            <mdui-menu-item value="cinematic">Cinematic</mdui-menu-item>
          </mdui-select>
        </div>
        <mdui-select label="Style (optional)" value.two-way="stylePreset">
          <mdui-menu-item value="">None</mdui-menu-item>
          <mdui-menu-item value="Noir black-and-white with deep contrast">Noir B&W</mdui-menu-item>
          <mdui-menu-item value="Faded postcard toning and soft vignette">Faded Postcard</mdui-menu-item>
          <mdui-menu-item value="VHS cassette artifacts and slight chroma bleed">VHS 90s</mdui-menu-item>
          <mdui-menu-item value="Polaroid instant film look">Polaroid 70s</mdui-menu-item>
          <mdui-menu-item value="Cyberpunk neon glow and reflective materials">Cyberpunk</mdui-menu-item>
          <mdui-menu-item value="Kodachrome film palette and grain">Kodachrome</mdui-menu-item>
          <mdui-menu-item value="Sepia tone and paper texture">Sepia 1900s</mdui-menu-item>
        </mdui-select>
        <mdui-text-field label="Negatives (optional)" value.two-way="negatives" type="textarea"></mdui-text-field>
        <div class="flex gap-2">
          <mdui-button variant="tonal" icon="shuffle" click.trigger="randomize()">Surprise me</mdui-button>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <mdui-button variant="filled" icon="bolt" disabled.bind="busy || !sourceFile || !auth.currentUser" click.trigger="generate()">Generate</mdui-button>
      <template if.bind="busy">
        <mdui-circular-progress indeterminate></mdui-circular-progress>
      </template>
      <template if.bind="error">
        <div class="text-sm text-red-600">${error}</div>
      </template>
      <template if.bind="quota">
        <mdui-chip clickable="false" class="text-sm">
          <mdui-icon name="bolt" slot="icon"></mdui-icon>
          ${quota.dailyRequests} / ${quota.dailyLimit} today ${auth.isAnonymous ? '(Guest)' : ''}
        </mdui-chip>
      </template>
    </div>
  </mdui-card>

  <mdui-card class="glass popover-safe p-5 space-y-4">
    <h3 class="text-lg font-semibold flex items-center gap-2">
      <mdui-icon name="image"></mdui-icon>
      Result
    </h3>
    <!-- Show compare container as soon as we have a source image.
         Overlay the result only after it's decoded (afterReady). -->
    <template if.bind="sourcePreview || resultImage">
      <div class="relative w-full max-w-full overflow-hidden rounded-xl checker ring-1 ring-black/5 select-none"
           style.bind="'aspect-ratio: ' + (sourceWidth && sourceHeight ? (sourceWidth + ' / ' + sourceHeight) : '4 / 3')"
           pointerdown.trigger="onSliderStart($event)"
           pointermove.trigger="onSliderMove($event)"
           pointerup.trigger="onSliderEnd()"
           pointerleave.trigger="onSliderEnd()">
        <!-- Base (original) keeps natural aspect ratio for container -->
        <img class="block w-full h-auto select-none"
             src.bind="sourcePreview || ''" alt="Original"
             decoding="async" width.bind="sourceWidth" height.bind="sourceHeight"/>
        <!-- After image overlaid and clipped to percentage; only reveal when ready -->
        <img if.bind="resultImage"
             class="absolute top-0 left-0 w-full h-auto select-none transition-opacity duration-200"
             src.bind="resultImage" alt="Result"
             decoding="async" width.bind="resultWidth" height.bind="resultHeight"
             style.bind="'opacity: ' + (afterReady ? '1' : '0') + '; clip-path: inset(0 ' + (100 - compare) + '% 0 0)'"/>
        <!-- Loading veil shown while result fetch/decoding is in progress -->
        <div class="absolute inset-0 grid place-items-center bg-black/5 dark:bg-white/5"
             if.bind="afterLoading && !afterReady">
          <div class="flex items-center gap-2 text-xs opacity-80 bg-white/70 dark:bg-black/40 rounded px-3 py-1.5 ring-1 ring-black/10">
            <mdui-circular-progress indeterminate></mdui-circular-progress>
            Preparing after image…
          </div>
        </div>
        <!-- Slider handle (disabled visual when after not ready) -->
        <div class="absolute inset-y-0" style.bind="'left: ' + compare + '%'">
          <div class="-translate-x-1/2 w-0.5 h-full bg-white/80 shadow opacity-90"></div>
          <div class="absolute top-1/2 -translate-x-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-white shadow ring-1 ring-black/10"
               style.bind="'opacity: ' + (afterReady ? '1' : '0.5')"></div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <input type="range" min="0" max="100" value.two-way="compare" disabled.bind="!afterReady"/>
        <span class="text-xs opacity-70">${compare}%</span>
      </div>
      <div class="flex flex-wrap gap-2">
        <mdui-button variant="tonal" icon="autorenew" disabled.bind="busy || !sceneId" click.trigger="reroll()">Reroll</mdui-button>
        <mdui-button variant="tonal" icon="zoom_in" click.trigger="openModal()" disabled.bind="!afterReady">View larger</mdui-button>
        <mdui-button variant="tonal" icon="download" click.trigger="downloadResult()" disabled.bind="!afterReady">Download</mdui-button>
      </div>

      <!-- Light modal for larger compare view -->
      <template if.bind="modalOpen">
        <div class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4" click.trigger="closeModal()" portal>
          <div class="relative w-full max-w-5xl" click.trigger="noop($event)">
            <div class="relative w-full overflow-hidden rounded-xl checker ring-1 ring-black/20 select-none"
                 style.bind="'aspect-ratio: ' + (sourceWidth && sourceHeight ? (sourceWidth + ' / ' + sourceHeight) : '4 / 3')"
                 pointerdown.trigger="onSliderStart($event)"
                 pointermove.trigger="onSliderMove($event)"
                 pointerup.trigger="onSliderEnd()"
                 pointerleave.trigger="onSliderEnd()">
              <img class="block w-full h-auto select-none" src.bind="sourcePreview || ''" alt="Original large"
                   decoding="async" width.bind="sourceWidth" height.bind="sourceHeight"/>
              <img if.bind="resultImage" class="absolute top-0 left-0 w-full h-auto select-none transition-opacity duration-200"
                   src.bind="resultImage" alt="Result large"
                   decoding="async" width.bind="resultWidth" height.bind="resultHeight"
                   style.bind="'opacity: ' + (afterReady ? '1' : '0') + '; clip-path: inset(0 ' + (100 - compare) + '% 0 0)'"/>
              <div class="absolute inset-0 grid place-items-center bg-black/5 dark:bg-white/5" if.bind="afterLoading && !afterReady">
                <div class="flex items-center gap-2 text-xs opacity-90 bg-black/40 text-white rounded px-3 py-1.5 ring-1 ring-white/20">
                  <mdui-circular-progress indeterminate></mdui-circular-progress>
                  Preparing after image…
                </div>
              </div>
              <div class="absolute inset-y-0" style.bind="'left: ' + compare + '%'">
                <div class="-translate-x-1/2 w-0.5 h-full bg-white/80 shadow"></div>
                <div class="absolute top-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-white shadow ring-1 ring-black/10"
                     style.bind="'opacity: ' + (afterReady ? '1' : '0.5')"></div>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <input type="range" min="0" max="100" value.two-way="compare" disabled.bind="!afterReady"/>
                <span class="text-xs opacity-70">${compare}%</span>
              </div>
              <div class="flex gap-2">
                <mdui-button variant="tonal" icon="download" click.trigger="downloadResult()" disabled.bind="!afterReady">Download</mdui-button>
                <mdui-button variant="filled" icon="close" click.trigger="closeModal()">Close</mdui-button>
              </div>
            </div>
          </div>
        </div>
      </template>
    </template>
    <template if.bind="!sourcePreview && !resultImage">
      <div class="text-sm opacity-70">No result yet</div>
    </template>
  </mdui-card>
</section>
